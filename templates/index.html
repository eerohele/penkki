<!DOCTYPE html>

<html>
   <head>
      <meta charset="utf-8">
      <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/c3/0.1.42/c3.css">
      <style type="text/css">
        body {
          color: #333;
          font-family: 'Helvetica Neue', Helvetica, sans-serif;
          text-align: center;
        }

        table {
          font-size: .8rem;
          margin: 0 auto;
          margin-top: 5em;
          margin-bottom: 5em;
        }

        thead {
          color: #444;
        }

        tfoot th {
          border-top: 1px solid #eee;
          font-weight: normal;
          padding-top: .5em;
        }

        tfoot th:first-child {
          border: none;
          color: #999;
          text-align: right;
        }

        tbody th {
          font-family: "Monaco", "Consolas", monospace;
          font-weight: normal;
          text-align: right;
        }

        tbody tr:last-child td, tbody tr:last-child th {
          padding-bottom: .25em;
        }

        td, th {
          padding: 0 1em;
        }

        .mean:after, .median:after {
          color: #999;
          content: 'ms';
        }

        #chart {
          margin-top: 50px;
        }

        footer {
          color: #666;
          font-size: .65rem;
          position: fixed;
          bottom: 0;
          right: 1em;
        }

        footer a {
          color: #999;
        }
      </style>
   </head>
   <body>
      <div id="chart"></div>

      <table>
        <tfoot>
          <tr>
            <th>Î”</th>
            <th class="mean"/>
            <th class="median"/>
            <th class="variance"/>
          </tr>
        </tfoot>

        <thead>
          <tr>
            <th/>
            <th>Mean</th>
            <th>Median</th>
            <th>Variance</th>
          </tr>
        </thead>

        <tbody id="tbody">
        </tbody>
      </table>

      <footer>
        <p>generated with <a href="https://www.npmjs.com/package/penkki">penkki</a></p>
      </footer>

      <script src="https://cdn.jsdelivr.net/d3js/3.5.10/d3.min.js"></script>
      <script src="https://cdn.jsdelivr.net/c3/0.1.42/c3.min.js"></script>

      <script id="data">
      </script>

      <script>
        var chart = c3.generate({
            bindto: '#chart',

            padding: {
              top: 50
            },

            data: {
              columns: COLUMNS
            },

            transition: {
              duration: 750
            },

            axis: {
              y: {
                label: {
                  text: "milliseconds",
                  position: "outer-middle"
                }
              },

              x: {
                tick: {
                  format: function (x) { return x + 1 }
                }
              }
            }
        })

        function round(n) {
          return Math.round(n * 100) / 100
        }

        function mean(values) {
          return round(values.reduce(function(acc, n) {
            return acc + n
          }, 0) / values.length)
        }

        function median(values) {
          values.sort(function(a, b) { return a - b })

          var result, half = Math.floor(values.length / 2)

          if (values.length % 2) {
            result = values[half]
          } else {
            result = (values[half - 1] + values[half]) / 2.0
          }

          return round(result)
        }

        function variance(values) {
          var m = mean(values)

          return round(values.reduce(function(acc, n) {
            return acc + (m - n) * (m - n)
          }, 0) / values.length)
        }

        function calculateDiffs(result) {
          return result.reduce(function (acc, x) {
            for (prop in acc) {
              if (acc.hasOwnProperty(prop)) {
                acc[prop] = Math.abs(round(x[prop] - acc[prop]))
              }
            }

            return acc
          }, { mean: 0, median: 0, variance: 0 })
        }

        function calculate(columns, functions) {
          return columns.map(function (col) {
            return functions.reduce(function (acc, f) {
              acc[f.name] = f(col.slice(1))
              return acc
            }, {})
          })
        }

        function setDiffs(diffs) {
          document.querySelector('tfoot .mean').textContent = diffs.mean
          document.querySelector('tfoot .median').textContent = diffs.median
          document.querySelector('tfoot .variance').textContent = diffs.variance
        }

        function tablify(columns, functions) {
          var result = calculate(columns, functions)

          setDiffs(calculateDiffs(result))

          result.forEach(function (result, i) {
            var tr = document.createElement('tr'),
                th = document.createElement('th')

            th.textContent = columns[i][0]
            tr.appendChild(th)

            for (value in result) {
              if (result.hasOwnProperty(value)) {
                var td = document.createElement('td')
                td.textContent = result[value]
                td.setAttribute('class', value)
                tr.appendChild(td)
              }
            }

            document.getElementById('tbody').appendChild(tr)
          })
        }

        tablify(COLUMNS, [mean, median, variance])
      </script>
   </body>
</html>
